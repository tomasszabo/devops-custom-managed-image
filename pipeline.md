
# Using managed images in VM Scale Sets for DevOps - building using DevOps pipeline

## How it works

1. Pipelines are adapted version of [pipelines from Runner images GitHub repository](https://github.com/actions/runner-images/tree/main/images.CI/linux-and-win/azure-pipelines). 
2. After starting pipeline, it checkouts latest version of [Runner images GitHub repository](https://github.com/actions/runner-images) but the adapted version is executed (not the original one).
3. Packer is used to create a VHD image which is afterwards stored in storage account.
4. VHD image is converted to managed image and stored as new managed image version in gallery.
5. When VM Scale Set used as DevOps agent pool is configured to use the latest version of managed image from gallery, VM instances will use the latest version from gallery once they are (re)created.

## Installation

## 1. Create VM Scale Set

First you need to use a self hosted agent in DevOps (see [Create VM Scale Set Agent Pool in DevOps](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/scale-set-agents?view=azure-devops)) which will be used to build first managed image. Using Microsoft hosted agents is not recommended as the build for e.g. Windows takes ca 5 hours and Microsoft hosted agents have timeout 60 minutes for private project which is not sufficient.

Recommended approach is to build managed image [locally on your computer](local.md) where you create VHD image, then convert it to managed imaged, create VM Scale Set and register it as self hosted agent in DevOps. Afterwards you can use this VM Scale Set for continuous building of managed images using pipelines which is described in following steps.

Following manual [Locally on your computer](local.md) will also create compute gallery, managed image definition and managed image version resources that are referenced in following steps.

## 2. Fork Git repository 

Fork Git repository https://github.com/tomasszabo/devops-custom-managed-image to your GitHub account so it will be available under your account in next step.

## 3. Create pipeline

Create build pipeline in DevOps:

1. Go to `DevOps > YOUR PROJECT > Pipelines > Pipelines > New Pipeline`.
2. Select `GitHub YAML` login with your GitHub credentials (if necessary) and select repository `devops-custom-managed-image` as source for pipeline.
3. Select `Existing Azure Pipelines YAML file` option.
4. Choose branch `main` and path `/images.CI/linux-and-win/azure-pipelines/windows2022.yml`.
5. We need to configure variable group prior to running this pipeline, therefore under button `Run` choose option `Save`. 

> NOTE: Only `windows2022.yml` and `windows2019.yaml` were adapted for building images using this manual. Other YAML files must be adapted prior running DevOps pipelines.

## 4. Configure variable group

We need to configure variable group prior to running this pipeline.

1. Go to `DevOps > YOUR PROJECT > Pipelines > Library` and with button `+ Variable group` create new variable group.
2. Enter name `Image Generation Variables`.
3. Add following variables:

|Variable|Example value|Description|
|--------|-------------|-----------|
|AZURE_GALLERY|MyGallery|Azure Compute Gallery used to store managed images for VM Scale Set|
|AZURE_LOCATION|westeurope|Location of temporary resources created by Packer when building VHD image|
|AZURE_RESOURCE_GROUP|devops-pipeline-01-rg|Resource group name where is your storage account for storing VHD files created by Packer|
|AZURE_STORAGE_ACCOUNT|devopspipelineimage01|Storage account name for storing VHD files created by Packer|
|AZURE_SUBSCRIPTION|19c6ef8a-...-3027|Subscription id where temporary resources should be created|
|AZURE_TENANT|19c6ef8a-...-3027|Tenant id where your service principal is registered|
|CLIENT_ID|19c6ef8a-...-3027|Service principal id used by Packer to create temporary resources. Service principal needs `Contributor` role for `AZURE_SUBSCRIPTION` so Packer is able to create temporary resources.|
|CLIENT_SECRET|*****|Service principal secret created when creating service principal. Store it as type `secret` (type is changed using lock icon).|
|CUSTOM_REPOSITORY_BRANCH|main|Branch for `CUSTOM_REPOSITORY_URL`, use `main` branch|
|CUSTOM_REPOSITORY_URL|https://github.com/actions/runner-images|Original [runner images GitHub repository](https://github.com/actions/runner-images)|

4. Under `Pipeline security` button in top menu you may restrict pipelines access to this repository.
5. Save your changes!

## 6. Run pipeline

Go to `DevOps > YOUR PROJECT > Pipelines > Pipelines > YOUR PIPELINE` and click `Run pipeline` button. Enter `Service Connection` name. Service connection is used to connect to storage account and convert VHD file generated by Packer to managed image stored in Compute Gallery. May be the same service connection that is used for VMSS agent pool.

> NOTE: `Service connection` needs to be a parameter instead of variable as it is used in `AzurePowerShell` task which needs to resolve `service connection` at compile time (parameter), not run time (variable). 

> NOTE: `Service principal` used in `Service connection` needs to have at least `Storage Blob Data Reader` role to be able to list blobs in storage account. Role `Contributor` is not enough, need to add `Storage Blob Data Reader` role explicitly. May be set on storage account level, not needed on subscription level.